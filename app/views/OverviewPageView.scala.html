@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import views.html.headerFooterTemplate.Layout
@import views.html.templates.helpers.Heading
@import views.html.templates.helpers.Button
@import views.html.templates.helpers.NotificationBanner
@import views.html.templates.helpers.Link
@import common.IncomeSources._

@this(layout: Layout, heading: Heading, button: Button, govukInsetText : GovukInsetText, formWithCSRF: FormWithCSRF, govUkButton: GovukButton, govukTag: GovukTag, notificationBanner: NotificationBanner, link: Link)
@(isAgent: Boolean, incomeSources: Option[IncomeSourcesModel], tailoring: OverviewTailoringModel, taxYear: Int, isInYear: Boolean, excludedJourneys: Seq[String])(implicit request: Request[_], messages: Messages, appConfig: AppConfig)

@statusTag(updatedCondition: Boolean, enabledCondition: Boolean, cannotUpdateCondition: Boolean = false, isMandatorySection: Boolean = false, isExcluded: Boolean = false) = {
    <span class="hmrc-status-tag">
        @govukTag(Tag(
            content = Text(if(enabledCondition){
                if(updatedCondition) {
                    messages("overview.updated")
                } else if(cannotUpdateCondition) {
                    messages("overview.cannotUpdate")
                } else if(isExcluded && appConfig.tailoringEnabled) {
                    messages("overview.excluded")
                } else if(isMandatorySection) {
                    messages("overview.todo")
                } else {
                    messages("overview.notStarted")
                }
            } else {
                messages("common.underMaintenance")
            }),
            classes = if(!updatedCondition || !enabledCondition) "govuk-tag--grey" else ""
        ))
    </span>
}

@taskListItem(show: Boolean, enabled: Boolean, linkId: String, taskNameKey: String, href: String, journeyKey: String, statusTagUpdatedCondition: Boolean, cannotUpdateCondition: Boolean = false, isMandatorySection: Boolean = false, additionalShowLinkCheck: Boolean = true) = {
    @if(!appConfig.tailoringEnabled || show) {
        <li class="app-task-list__item">
            <span class="app-task-list__task-name">
            @if(enabled && additionalShowLinkCheck) {
                <a class="govuk-link" id="@linkId" href="@href">
                @messages(taskNameKey)
                </a>
            } else {
                @messages(taskNameKey)
            }
            </span>
            @statusTag(statusTagUpdatedCondition, enabled, cannotUpdateCondition, isMandatorySection, excludedJourneys.contains(journeyKey))
        </li>
    }
}

@interestUrlRedirect(incomeSources: IncomeSourcesModel) = @{
    if(incomeSources.interest.exists(accounts => accounts.exists(_.hasAmounts))) {
        appConfig.personalIncomeTaxInterestSubmissionCYAUrl(taxYear)
    } else {
        if(appConfig.tailoringEnabled && false) { //TODO Remove 'false' when the pitsf part of the journey is ready
            appConfig.personalIncomeTaxInterestGatewayUrl(taxYear)
        } else {
            appConfig.personalIncomeTaxInterestUrl(taxYear)
        }
    }
}

@taskWithActionList(caption: String, index: Option[Int], incomeSources: IncomeSourcesModel, warningEOY: String) = {
    <ol style="padding-left:0;" class="app-task-list__items govuk-!-padding-bottom-1">
        @taskListItem(
            tailoring.hasInterest,
            appConfig.interestEnabled,
            "interest_link",
            "common.interest",
            interestUrlRedirect(incomeSources),
            INTEREST,
            incomeSources.interest.exists(accounts => accounts.exists(_.hasAmounts))
        )
        
        @taskListItem(
            tailoring.hasDividends,
            appConfig.dividendsEnabled,
            "dividends_link",
            "common.dividends",
            if(incomeSources.dividends.isEmpty) {appConfig.personalIncomeTaxDividendsUrl(taxYear)} else {appConfig.personalIncomeTaxDividendsSubmissionCYAUrl(taxYear)},
            DIVIDENDS,
            incomeSources.dividends.isDefined
        )

        @taskListItem(
            appConfig.giftAidReleased && tailoring.hasGiftAid,
            appConfig.giftAidEnabled,
            "giftAid_link",
            "common.donationsToCharity",
            if(incomeSources.giftAid.isEmpty) {appConfig.personalIncomeTaxGiftAidUrl(taxYear)} else {appConfig.personalIncomeTaxGiftAidSubmissionCYAUrl(taxYear)},
            GIFT_AID,
            incomeSources.giftAid.isDefined
        )

        @taskListItem(
            appConfig.employmentReleased && tailoring.hasEmployment,
            appConfig.employmentEnabled,
            "employment_link",
            if(appConfig.studentLoansEnabled) { "common.employmentSL" } else { "common.employment" },
            appConfig.employmentFEUrl(taxYear),
            EMPLOYMENT,
            incomeSources.employment.isDefined,
            (isInYear || !appConfig.employmentEOYEnabled),
            isMandatorySection = true,
            additionalShowLinkCheck = ((incomeSources.employment.isDefined && isInYear) || (appConfig.employmentEOYEnabled && !isInYear))
        )

        @taskListItem(
            appConfig.cisReleased && tailoring.hasCis,
            appConfig.cisEnabled,
            "cis_link",
            "common.cis",
            appConfig.cisFEUrl(taxYear),
            CIS,
            incomeSources.cis.isDefined,
            isInYear,
            additionalShowLinkCheck = incomeSources.cis.isDefined || !isInYear
        )

        @taskListItem(
            appConfig.pensionsReleased && tailoring.hasPensions,
            appConfig.pensionsEnabled,
            "pensions_link",
            "common.pensions",
            appConfig.pensionsSummaryUrl(taxYear),
            PENSIONS,
            incomeSources.pensions.isDefined
        )
        @if(appConfig.tailoringEnabled){
            @if(!tailoring.allJourneys.contains(true)){
                @govukInsetText(InsetText(
                    content = Text( messages(s"overview.tailoring.insertText.${if(isAgent) "agent" else "individual"}"))
                ))
            }

            <li class="govuk-!-margin-top-4">
                <span class="app-task-list__task-name">
                    @link(controllers.routes.AddSectionsToIncomeTaxReturnController.show(taxYear).url, s"addSections.title.${if(isAgent) "agent" else "individual"}", Some("addSectionsLink"))
                </span>
            </li>
        }
    </ol>
}



@checkSubmitIncomeTaxReturn(captionEOY: String, headingEOY: String) = {
        @if(!isInYear)  {
            <h2 class="govuk-heading-m" id="heading-checkAndSubmit"> @headingEOY </h2>
            <p class="govuk-body" id="p-submitText">@captionEOY</p>
            @formWithCSRF(action = controllers.routes.OverviewPageController.finalCalculation(taxYear)) {
                @button()
            }
        }

}

@updateTaxCalculationInYear = {
    @if(appConfig.crystallisationEnabled && isInYear) {
        @formWithCSRF(action = controllers.routes.OverviewPageController.inYearEstimate(taxYear)) {
            @button(
                alternativeText = messages("overview.updateTaxCalculation"),
                alternativeId = Some("updateTaxCalculation")
            )
        }
    }
}

@affinityText = @{
    if(isAgent) "agent" else "individual"
}

@TailoringContent = {
    @if(tailoring.sourceCount==1){
        @notificationBanner(messages(s"overview.notificationBanner.${if(isAgent) "agent" else "individual"}", tailoring.sourceCount.toString()))
    }
    @if(tailoring.sourceCount>1){
        @notificationBanner(messages(s"overview.notificationBannerPlural.${if(isAgent) "agent" else "individual"}", tailoring.sourceCount.toString()))
    }

    <p class="govuk-body" id="p-checkSections">@messages("overview.tailoring")</p>
}

@NonTailoringContent(isInYear: Boolean) = {

    <p class="govuk-body">@messages(s"overview.paragraph.1.${if(isAgent) "agent" else "individual"}")</p>
    <p class="govuk-body">@messages("overview.paragraph.2")</p>

    @if(isInYear){
        @govukInsetText(InsetText(
            content = Text( messages(s"overview.insertText.${if(isAgent) "agent" else "individual"}", taxYear.toString))
        ))
    }

}


    
@overview = {
    @heading(messages(s"common.yourIncomeTaxReturn.$affinityText"), messages("common.caption", (taxYear - 1).toString, taxYear.toString))

    <h2 class="govuk-heading-m" id="heading-tasklist">@messages(s"overview.$affinityText.task1.heading")</h2>

    @if(appConfig.tailoringEnabled){
        @TailoringContent
    } else {
        @NonTailoringContent(isInYear)
    }
    
    @if(isAgent) {
        @taskWithActionList(messages("overview.task1.caption"), None, incomeSources.getOrElse(IncomeSourcesModel(None,None)), messages(s"overview.crystallisation.warning.agent"))
    } else {
        @taskWithActionList(messages("overview.task1.caption"), Some(1), incomeSources.getOrElse(IncomeSourcesModel(None,None)), messages(s"overview.crystallisation.warning.individual"))
    }

    @if(!appConfig.crystallisationEnabled){
        <p class="govuk-body govuk-!-margin-bottom-8" id="p-gotoAccountDetails">
            @messages(s"overview.paragraph.3.$affinityText")
            <a class="govuk-link" id="calculation_link" href="@if(isAgent) {@appConfig.viewAndChangeViewUrlAgent} else {@appConfig.viewAndChangeViewUrl}">
                @messages("common.incomeTaxAccount")
            </a>
            @messages(s"overview.paragraph.5.$affinityText")
        </p>
    }
    
    @checkSubmitIncomeTaxReturn(messages(s"overview.crystallisation.paragraph.$affinityText"), messages(s"overview.crystallisation.heading.EOY.$affinityText"))
    @updateTaxCalculationInYear


}
@layout(pageTitle = messages(s"common.yourIncomeTaxReturn.${if(isAgent) "agent" else "individual"}"), taxYear = Some(taxYear), isAgent = isAgent, isOverviewPage = true)(overview)

@{
// $COVERAGE-OFF$
}
