@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import views.html.headerFooterTemplate.Layout
@import views.html.templates.helpers.Heading
@import views.html.templates.helpers.Button
@import views.html.templates.helpers.NotificationBanner
@import views.html.templates.helpers.Link
@import views.html.templates.helpers.InsertText
@import common.IncomeSources._

@this(layout: Layout, heading: Heading, button: Button, govukInsetText : GovukInsetText, formWithCSRF: FormWithCSRF, govUkButton: GovukButton, govukTag: GovukTag, notificationBanner: NotificationBanner, link: Link, insertText: InsertText)
@(isAgent: Boolean, incomeSources: Option[IncomeSourcesModel], taxYear: Int, isInYear: Boolean, tailoring: Seq[String], tailoringUpdateCount: Int)(implicit request: Request[_], messages: Messages, appConfig: AppConfig)

@statusTag(updatedCondition: Boolean, enabledCondition: Boolean, cannotUpdateCondition: Boolean = false, isMandatorySection: Boolean = false) = {
    <span class="hmrc-status-tag">
        @govukTag(Tag(
            content = Text(if(enabledCondition){
                if(updatedCondition) {
                    messages("overview.updated")
                } else if(cannotUpdateCondition) {
                    messages("overview.cannotUpdate")
                } else if(isMandatorySection) {
                    messages("overview.todo")
                } else {
                    messages("overview.notStarted")
                }
            } else {
                messages("common.underMaintenance")
            }),
            classes = if(!updatedCondition || !enabledCondition) "govuk-tag--grey" else ""
        ))
    </span>
}

@taskListItem(enabled: Boolean, linkId: String, taskNameKey: String, href: String, statusTagUpdatedCondition: Boolean, cannotUpdateCondition: Boolean = false, isMandatorySection: Boolean = false, additionalShowLinkCheck: Boolean = true) = {
    <li class="app-task-list__item">
        <span class="app-task-list__task-name">
            @if(enabled && additionalShowLinkCheck){
                <a class="govuk-link" id="@linkId" href="@href">
                    @messages(taskNameKey)
                </a>
            } else {
                @messages(taskNameKey)
            }
        </span>
        @statusTag(statusTagUpdatedCondition, enabled, cannotUpdateCondition, isMandatorySection)
    </li>
}
    
@taskWithActionList(caption: String, index: Option[Int], incomeSources: IncomeSourcesModel, warningEOY: String) = {
    <ol style="padding-left:0;" class="app-task-list__items  govuk-!-padding-bottom-2">
        @if(tailoring.contains(INTEREST)){
            @taskListItem(
                appConfig.interestEnabled,
                "interest_link",
                "common.interest",
                if(incomeSources.interest.exists(accounts => accounts.exists(_.hasAmounts))) {appConfig.personalIncomeTaxInterestSubmissionCYAUrl(taxYear)} else {appConfig.personalIncomeTaxInterestUrl(taxYear)},
                incomeSources.interest.exists(accounts => accounts.exists(_.hasAmounts))
            )
        }
        @if(tailoring.contains(DIVIDENDS)){
            @taskListItem(
                appConfig.dividendsEnabled,
                "dividends_link",
                "common.dividends",
                if(incomeSources.dividends.isEmpty) {appConfig.personalIncomeTaxDividendsUrl(taxYear)} else {appConfig.personalIncomeTaxDividendsSubmissionCYAUrl(taxYear)},
                incomeSources.dividends.isDefined
            )
        }

        @if(appConfig.giftAidReleased){
            @if(tailoring.contains(GIFT_AID)){
                @taskListItem(
                    appConfig.giftAidEnabled,
                    "giftAid_link",
                    "common.donationsToCharity",
                    if(incomeSources.giftAid.isEmpty) {appConfig.personalIncomeTaxGiftAidUrl(taxYear)} else {appConfig.personalIncomeTaxGiftAidSubmissionCYAUrl(taxYear)},
                    incomeSources.giftAid.isDefined
                )
            }
        }

        @if(appConfig.employmentReleased){
            @if(tailoring.contains(EMPLOYMENT)){
                @taskListItem(
                    appConfig.employmentEnabled,
                    "employment_link",
                    "common.employment",
                    appConfig.employmentFEUrl(taxYear),
                    incomeSources.employment.isDefined,
                    (isInYear || !appConfig.employmentEOYEnabled),
                    isMandatorySection = true,
                    additionalShowLinkCheck = ((incomeSources.employment.isDefined && isInYear) || (appConfig.employmentEOYEnabled && !isInYear)),
                )
            }
        }

        @if(appConfig.cisReleased){
            @if(tailoring.contains(CIS)){
                @taskListItem(
                    appConfig.cisEnabled,
                    "cis_link",
                    "common.cis",
                    appConfig.cisFEUrl(taxYear),
                    incomeSources.cis.isDefined,
                    isInYear,
                    additionalShowLinkCheck = incomeSources.cis.isDefined || !isInYear
                )
            }
        }
<!--        @if(tailoring.isEmpty){-->
<!--            <li class="app-task-list__item">-->
<!--                <span class="app-task-list__task-name">-->
<!--                    @insertText(s"overview.insertText.${if(isAgent) "agent" else "individual"}")-->
<!--                </span>-->
<!--            </li>-->
<!--        }-->
        <li class="govuk-!-margin-top-4">
            <span class="app-task-list__task-name">
                @link("", s"overview.addSections.${if(isAgent) "agent" else "individual"}", Some("addSectionsLink"))
            </span>
        </li>
    </ol>


}



@checkSubmitIncomeTaxReturn(captionEOY: String, headingEOY: String) = {
        @if(!isInYear)  {
            <h2 class="govuk-heading-m" id="heading-checkAndSubmit"> @headingEOY </h2>
            <p class="govuk-body" id="p-submitText">@captionEOY</p>
            @formWithCSRF(action = controllers.routes.OverviewPageController.finalCalculation(taxYear)) {
                @button()
            }
        }

}

@updateTaxCalculationInYear = {
    @if(appConfig.crystallisationEnabled && isInYear) {
        @formWithCSRF(action = controllers.routes.OverviewPageController.inYearEstimate(taxYear)) {
            @button(
                alternativeText = messages("overview.updateTaxCalculation"),
                alternativeId = Some("updateTaxCalculation")
            )
        }
    }
}

@affinityText = @{
    if(isAgent) "agent" else "individual"
}

@TailoringNotificationBanner = @{
    if(tailoringUpdateCount==1){
        notificationBanner(messages(s"overview.notificationBanner.${if(isAgent) "agent" else "individual"}", tailoringUpdateCount.toString()))
    }
    else if(tailoringUpdateCount>1){
        notificationBanner(messages(s"overview.notificationBannerPlural.${if(isAgent) "agent" else "individual"}", tailoringUpdateCount.toString()))
    }
}

@overview = {
    @heading(messages(s"common.yourIncomeTaxReturn.$affinityText"), messages("common.caption", (taxYear - 1).toString, taxYear.toString))

    @TailoringNotificationBanner

    <h2 class="govuk-heading-m" id="heading-tasklist">@messages(s"overview.$affinityText.task1.heading")</h2>

    <p class="govuk-body" id="p-checkSections">@messages("overview.paragraph.1")</p>
    
    @if(isAgent) {
        @taskWithActionList(messages("overview.task1.caption"), None, incomeSources.getOrElse(IncomeSourcesModel(None,None)), messages(s"overview.crystallisation.warning.agent"))
    } else {
        @taskWithActionList(messages("overview.task1.caption"), Some(1), incomeSources.getOrElse(IncomeSourcesModel(None,None)), messages(s"overview.crystallisation.warning.individual"))
    }

    @if(!appConfig.crystallisationEnabled){
        <p class="govuk-body govuk-!-margin-bottom-8" id="p-gotoAccountDetails">
            @messages(s"overview.paragraph.3.$affinityText")
            <a class="govuk-link" id="calculation_link" href="@if(isAgent) {@appConfig.viewAndChangeViewUrlAgent} else {@appConfig.viewAndChangeViewUrl}">
                @messages("overview.paragraph.4")
            </a>
            @messages(s"overview.paragraph.5.$affinityText")
        </p>
    }
    
    @checkSubmitIncomeTaxReturn(messages(s"overview.crystallisation.paragraph.$affinityText"), messages(s"overview.crystallisation.heading.EOY.$affinityText"))
    @updateTaxCalculationInYear


}
@layout(pageTitle = messages(s"common.yourIncomeTaxReturn.${if(isAgent) "agent" else "individual"}"), taxYear = Some(taxYear), isAgent = isAgent, isOverviewPage = true)(overview)

@{
// $COVERAGE-OFF$
}
